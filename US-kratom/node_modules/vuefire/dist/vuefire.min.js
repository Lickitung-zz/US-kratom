/*!
 * vuefire v2.0.0-alpha.24
 * (c) 2019 Eduardo San Martin Morote
 * Released under the MIT License.
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).Vuefire={})}(this,function(e){"use strict";function h(e){return Object.defineProperty(e.data(),"id",{value:e.id})}function s(e){return e&&"object"==typeof e}function b(r,i,o,e){void 0===i&&(i={}),void 0===o&&(o=""),void 0===e&&(e=[{},{}]),i=i||{};var t=Object.getOwnPropertyDescriptor(r,"id");return t&&!t.enumerable&&Object.defineProperty(e[0],"id",t),Object.keys(r).reduce(function(e,t){var n=r[t];return!function(e){return e&&e.onSnapshot}(n)?Array.isArray(n)?(e[0][t]=Array(n.length).fill(null),b(n,i[t],o+t+".",[e[0][t],e[1]])):null==n||n instanceof Date||function(e){return e.toDate}(n)||n.longitude&&n.latitude?e[0][t]=n:s(n)?(e[0][t]={},b(n,i[t],o+t+".",[e[0][t],e[1]])):e[0][t]=n:(e[0][t]=i[t]||n.path,e[1][o+t]=n),e},e)}function r(e,t,n){var r=(""+t).split("."),i=r.pop(),o=r.reduce(function(e,t){return e[t]},e);return o.splice?o.splice(i,1,n):o[i]=n}function v(e){var t,n=e.val();return s(n)?t=n:(t={},Object.defineProperty(t,".value",{value:n})),Object.defineProperty(t,".key",{value:e.key}),t}function p(e,t){for(var n=0;n<e.length;n++)if(e[n][".key"]===t)return n;return-1}var y={reset:!0};var m={maxRefDepth:2,reset:!0};function g(e){for(var t in e)e[t].unsub()}function j(e,i){var o=e.subs,s=e.refs,f=e.target,c=e.path,u=e.depth,a=e.ops,d=e.resolve,t=Object.keys(s);if(Object.keys(o).filter(function(e){return t.indexOf(e)<0}).forEach(function(e){o[e].unsub(),delete o[e]}),!t.length||++u>i.maxRefDepth)return d(c);var l=0,v=t.length,p=Object.create(null);t.forEach(function(e){var t=o[e],n=s[e],r=c+"."+e;if(p[r]=!0,t){if(t.path===n.path)return;t.unsub()}o[e]={unsub:function(e,t){var n=e.ref,r=e.target,i=e.path,o=e.depth,s=e.resolve,f=e.ops,c=Object.create(null),u=n.onSnapshot(function(e){e.exists?_({snapshot:h(e),target:r,path:i,ops:f,subs:c,depth:o,resolve:s},t):(f.set(r,i,null),s(i))});return function(){u(),g(c)}}({ref:n,target:f,path:r,depth:u,ops:a,resolve:function(e){e in p&&++l>=v&&d(c)}.bind(null,r)},i),path:n.path}})}function _(e,t){var n=e.snapshot,r=e.target,i=e.path,o=e.subs,s=e.ops,f=e.depth;void 0===f&&(f=0);var c=e.resolve,u=b(n,function(e,t){return t.split(".").reduce(function(e,t){return e[t]},e)}(r,i)),a=u[0],d=u[1];s.set(r,i,a),j({data:a,subs:o,refs:d,target:r,path:i,ops:s,depth:f,resolve:c},t)}function o(e){return"object"==typeof e.ref&&(e=e.ref),e}var f={set:function(e,t,n){return r(e,t,n)},add:function(e,t,n){return e.splice(t,0,n)},remove:function(e,t){return e.splice(t,1)}};function c(r,i,o,s){return new Promise(function(e,t){var n;n=Array.isArray(r[i])?function(e,t){var n=e.vm,r=e.key,i=e.collection,o=e.resolve,s=e.reject,f=e.ops;void 0===t&&(t=y),t=Object.assign({},y,t);var c=[];f.set(n,r,c);var u=i.on("child_added",function(e,t){var n=t?p(c,t)+1:0;f.add(c,n,v(e))},s),a=i.on("child_removed",function(e){f.remove(c,p(c,e.key))},s),d=i.on("child_changed",function(e){f.set(c,p(c,e.key),v(e))},s),l=i.on("child_moved",function(e,t){var n=p(c,e.key),r=f.remove(c,n)[0],i=t?p(c,t)+1:0;f.add(c,i,r)},s);return i.once("value",o),function(){if(i.off("child_added",u),i.off("child_changed",d),i.off("child_removed",a),i.off("child_moved",l),!1!==t.reset){var e="function"==typeof t.reset?t.reset():[];f.set(n,r,e)}}}({vm:r,key:i,collection:o,resolve:e,reject:t,ops:f},s):function(e,t){var n=e.vm,r=e.key,i=e.document,o=e.resolve,s=e.reject,f=e.ops;void 0===t&&(t=y),t=Object.assign({},y,t);var c=i.on("value",function(e){f.set(n,r,v(e))},s);return i.once("value",o),function(){if(i.off("value",c),!1!==t.reset){var e="function"==typeof t.reset?t.reset():null;f.set(n,r,e)}}}({vm:r,key:i,document:o,resolve:e,reject:t,ops:f},s),r._firebaseUnbinds[i]=n})}var u={set:function(e,t,n){return r(e,t,n)},add:function(e,t,n){return e.splice(t,0,n)},remove:function(e,t){return e.splice(t,1)}};function a(e,r){var i=e.vm,o=e.key,s=e.ref,f=e.ops;return new Promise(function(e,t){var n;n=s.where?function(e,u){var o=e.vm,s=e.key,t=e.collection,a=e.ops,d=e.resolve,n=e.reject;void 0===u&&(u=m),u=Object.assign({},m,u);var f,l=a.set(o,s,[]),c=d,v=[],p={added:function(e){var t=e.newIndex,n=e.doc;v.splice(t,0,Object.create(null));var r=v[t],i=b(h(n)),o=i[0],s=i[1];a.add(l,t,o),j({refs:s,subs:r,target:l,path:t,depth:0,ops:a,resolve:d.bind(null,n)},u)},modified:function(e){var t=e.oldIndex,n=e.newIndex,r=e.doc,i=v.splice(t,1)[0];v.splice(n,0,i);var o=a.remove(l,t)[0],s=b(h(r),o),f=s[0],c=s[1];a.add(l,n,f),j({data:f,refs:c,subs:i,ops:a,target:l,path:n,depth:0,resolve:d},u)},removed:function(e){var t=e.oldIndex;a.remove(l,t),g(v.splice(t,1)[0])}},r=t.onSnapshot(function(e){var t="function"==typeof e.docChanges?e.docChanges():e.docChanges;if(!f&&t.length){f=!0;var n=0,r=t.length,i=t.reduce(function(e,t){return e[t.doc.id]=!1,e},Object.create(null));d=function(e){e.id in i&&++n>=r&&(c(o[s]),d=function(){})}}t.forEach(function(e){p[e.type](e)}),t.length||d()},n);return function(){if(r(),!1!==u.reset){var e="function"==typeof u.reset?u.reset():[];a.set(o,s,e)}v.forEach(g)}}({vm:i,key:o,ops:f,collection:s,resolve:e,reject:t},r):function(e,t){var n=e.vm,r=e.key,i=e.document,o=e.resolve,s=e.reject,f=e.ops;void 0===t&&(t=m),t=Object.assign({},m,t);var c=Object.create(null);o=function(e,t){var n;return function(){if(!n)return n=!0,e(t())}}(o,function(){return n[r]});var u=i.onSnapshot(function(e){e.exists?_({snapshot:h(e),target:n,path:r,subs:c,ops:f,resolve:o},t):o()},s);return function(){if(u(),!1!==t.reset){var e="function"==typeof t.reset?t.reset():null;f.set(n,r,e)}g(c)}}({vm:i,key:o,ops:f,document:s,resolve:e,reject:t},r),i._firestoreUnbinds[o]=n})}e.firestorePlugin=function(e,t){void 0===t&&(t={});var r=t.bindName;void 0===r&&(r="$bind");var i=t.unbindName;void 0===i&&(i="$unbind");var n=e.config.optionMergeStrategies;n.firestore=n.provide,e.mixin({beforeCreate:function(){this._firestoreUnbinds=Object.create(null),this.$firestoreRefs=Object.create(null)},created:function(){var t=this,e=this.$options.firestore,n="function"==typeof e?e.call(this):e;n&&Object.keys(n).forEach(function(e){t[r](e,n[e])})},beforeDestroy:function(){for(var e in this._firestoreUnbinds)this._firestoreUnbinds[e]();this._firestoreUnbinds=null,this.$firestoreRefs=null}}),e.prototype[r]=function(e,t,n){this._firestoreUnbinds[e]&&this[i](e);var r=a({vm:this,key:e,ref:t,ops:u},n);return this.$firestoreRefs[e]=t,r},e.prototype[i]=function(e){this._firestoreUnbinds[e](),delete this._firestoreUnbinds[e],delete this.$firestoreRefs[e]}},e.getRef=o,e.rtdbPlugin=function(e,t){void 0===t&&(t={});var n=t.bindName;void 0===n&&(n="$rtdbBind");var i=t.unbindName;void 0===i&&(i="$rtdbUnbind");var r=e.config.optionMergeStrategies;r.firebase=r.provide,e.mixin({beforeCreate:function(){this.$firebaseRefs=Object.create(null),this._firebaseSources=Object.create(null),this._firebaseUnbinds=Object.create(null)},created:function(){var e=this.$options.firebase;if("function"==typeof e&&(e=e.call(this)),e)for(var t in e)this[n](t,e[t])},beforeDestroy:function(){for(var e in this._firebaseUnbinds)this._firebaseUnbinds[e]();this._firebaseSources=null,this._firebaseUnbinds=null,this.$firebaseRefs=null}}),e.prototype[n]=function(e,t,n){this._firebaseUnbinds[e]&&this[i](e);var r=c(this,e,t,n);return this._firebaseSources[e]=t,this.$firebaseRefs[e]=o(t),r},e.prototype[i]=function(e){!function(e,t){e._firebaseUnbinds[t](),delete e._firebaseSources[t],delete e._firebaseUnbinds[t]}(this,e)}},Object.defineProperty(e,"__esModule",{value:!0})});